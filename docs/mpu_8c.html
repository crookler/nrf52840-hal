<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Embedded from Scratch: mpu.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Embedded from Scratch
   &#160;<span id="projectnumber">Project</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('mpu_8c.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">mpu.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Helper functions for managing the MPU and using its peripheral registers in the SCS.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;<a class="el" href="mpu_8h_source.html">mpu.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="printk_8h_source.html">printk.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="multitask_8h_source.html">multitask.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="error_8h_source.html">error.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="syscall_8h_source.html">syscall.h</a>&quot;</code><br />
</div><div class="textblock"><div class="dynheader">
Include dependency graph for mpu.c:</div>
<div class="dyncontent">
<div class="center"><img src="mpu_8c__incl.png" border="0" usemap="#ampu_8c" alt=""/></div>
<map name="ampu_8c" id="ampu_8c">
<area shape="rect" title="Helper functions for managing the MPU and using its peripheral registers in the SCS." alt="" coords="185,5,248,32"/>
<area shape="rect" href="mpu_8h.html" title="MMIO addresses and common enums/structs for working with the memory protection unit." alt="" coords="5,155,68,181"/>
<area shape="rect" href="printk_8h.html" title="Prototypes for printk (print to debugger as a wrapper of rtt.h)" alt="" coords="73,80,145,107"/>
<area shape="rect" href="multitask_8h.html" title="Stores syscall function prototypes and kernel level structs for managing inter&#45;process states." alt="" coords="169,80,265,107"/>
<area shape="rect" href="error_8h.html" title="Constants for unified error codes across all peripherals. Each error code specifies exactly one uniqu..." alt="" coords="403,80,467,107"/>
<area shape="rect" href="syscall_8h.html" title="Contains stubs and structs useful for handling the SVC handler and letting it support syscalls/additi..." alt="" coords="352,229,431,256"/>
<area shape="rect" href="arm_8h.html" title="Macro definitions, typedefs, and aliases for common ARM functionality." alt="" coords="169,304,229,331"/>
<area shape="rect" href="rtt_8h.html" title="Function prototpyes and struct definitions for writing/reading to the up and down buffer of the debug..." alt="" coords="75,229,124,256"/>
<area shape="rect" href="thread_8h.html" title="Common ethread structs and constants needed according source files aiding with mulititasking." alt="" coords="200,229,276,256"/>
<area shape="rect" href="mutex_8h.html" title="Provides stubs and data structures for implementing mutual exclusion." alt="" coords="252,155,328,181"/>
</map>
</div>
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ab1fe9da34b8e7f2bc2fc372ab231fd55"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="mpu_8c.html#ab1fe9da34b8e7f2bc2fc372ab231fd55">mpu_region_enable</a> (<a class="el" href="arm_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> region, void *base_addr, <a class="el" href="arm_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> size_log2, <a class="el" href="arm_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> execute, <a class="el" href="arm_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> write)</td></tr>
<tr class="memdesc:ab1fe9da34b8e7f2bc2fc372ab231fd55"><td class="mdescLeft">&#160;</td><td class="mdescRight">enables an aligned memory protection region  <a href="mpu_8c.html#ab1fe9da34b8e7f2bc2fc372ab231fd55">More...</a><br /></td></tr>
<tr class="separator:ab1fe9da34b8e7f2bc2fc372ab231fd55"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aaff8e4368cff6bd1ffddc24cc0310dec"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="mpu_8c.html#aaff8e4368cff6bd1ffddc24cc0310dec">mpu_region_disable</a> (<a class="el" href="arm_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> region)</td></tr>
<tr class="memdesc:aaff8e4368cff6bd1ffddc24cc0310dec"><td class="mdescLeft">&#160;</td><td class="mdescRight">Disables a memory protection region.  <a href="mpu_8c.html#aaff8e4368cff6bd1ffddc24cc0310dec">More...</a><br /></td></tr>
<tr class="separator:aaff8e4368cff6bd1ffddc24cc0310dec"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2d681c0394e5104195a6486a2feecd9e"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="mpu_8c.html#a2d681c0394e5104195a6486a2feecd9e">mpu_enable</a> ()</td></tr>
<tr class="separator:a2d681c0394e5104195a6486a2feecd9e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afb390ac802137661de74920293dbef05"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="mpu_8c.html#afb390ac802137661de74920293dbef05">mpu_disable</a> ()</td></tr>
<tr class="separator:afb390ac802137661de74920293dbef05"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a501ff979f58c03b4993d2cbb8f9db40d"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="mpu_8c.html#a501ff979f58c03b4993d2cbb8f9db40d">mpu_thread_region_enable</a> (void *base_addr, <a class="el" href="arm_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> size)</td></tr>
<tr class="separator:a501ff979f58c03b4993d2cbb8f9db40d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a61da86fe203ca5a3604409503ce1b3ca"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="mpu_8c.html#a61da86fe203ca5a3604409503ce1b3ca">mpu_thread_region_disable</a> ()</td></tr>
<tr class="separator:a61da86fe203ca5a3604409503ce1b3ca"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4be799271460d88069f9c2354969e64b"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="mpu_8c.html#a4be799271460d88069f9c2354969e64b">mpu_kernel_region_enable</a> (void *base_addr, <a class="el" href="arm_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> size)</td></tr>
<tr class="separator:a4be799271460d88069f9c2354969e64b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aee4104f705af43dccb9fc4e034823790"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="mpu_8c.html#aee4104f705af43dccb9fc4e034823790">mpu_kernel_region_disable</a> ()</td></tr>
<tr class="separator:aee4104f705af43dccb9fc4e034823790"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8a859fc523c4884c34e23bd1d28d3484"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="mpu_8c.html#a8a859fc523c4884c34e23bd1d28d3484">MemFault_C_Handler</a> (void *psp)</td></tr>
<tr class="separator:a8a859fc523c4884c34e23bd1d28d3484"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Helper functions for managing the MPU and using its peripheral registers in the SCS. </p>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="a8a859fc523c4884c34e23bd1d28d3484"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8a859fc523c4884c34e23bd1d28d3484">&#9670;&nbsp;</a></span>MemFault_C_Handler()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void MemFault_C_Handler </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>psp</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Takes the <code>psp</code> of the faulting instruction and compares against known flags in the CFSR to determine the cause of the MemFault. If the psp experienced stack overflow or underflow (and potentially corrupted other stacks), the entire user application exists. Otherwise, just the out-of-line thread is ended (through the kernel level call to syscall_thread_end). </p>

</div>
</div>
<a id="afb390ac802137661de74920293dbef05"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afb390ac802137661de74920293dbef05">&#9670;&nbsp;</a></span>mpu_disable()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void mpu_disable </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Disables the MPU and regresses to using the default memory map for unpriviledged access (i.e. flips HFNMIENA and ENABLE bits). </p>

</div>
</div>
<a id="a2d681c0394e5104195a6486a2feecd9e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2d681c0394e5104195a6486a2feecd9e">&#9670;&nbsp;</a></span>mpu_enable()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void mpu_enable </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Creates default memory protection regeions for user test, user read only data, user data/bss, heap, and main thread stacks. Enables the MPU with the background memory region and allows high priority system handler access to be handled by MPU. </p>

</div>
</div>
<a id="aee4104f705af43dccb9fc4e034823790"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aee4104f705af43dccb9fc4e034823790">&#9670;&nbsp;</a></span>mpu_kernel_region_disable()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void mpu_kernel_region_disable </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Deactive the memory protection region associated with the kernel stack. Will always deactive region 7 (as this is what is assigned above). </p>

</div>
</div>
<a id="a4be799271460d88069f9c2354969e64b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4be799271460d88069f9c2354969e64b">&#9670;&nbsp;</a></span>mpu_kernel_region_enable()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void mpu_kernel_region_enable </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>base_addr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="arm_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>&#160;</td>
          <td class="paramname"><em>size</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Creates a kernel stack thread memory protection region according to whether the user wants to protect individual threads or just the kernel. If the user application only wants to protect kernel, a single region covers the entire range of thread kernel stack space (else this thread should only access its own kernel stack space) Thread will have RW access to its own kernel stack space. </p>

</div>
</div>
<a id="aaff8e4368cff6bd1ffddc24cc0310dec"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aaff8e4368cff6bd1ffddc24cc0310dec">&#9670;&nbsp;</a></span>mpu_region_disable()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void mpu_region_disable </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="arm_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>&#160;</td>
          <td class="paramname"><em>region</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Disables a memory protection region. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">region</td><td>Region number to disable </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="ab1fe9da34b8e7f2bc2fc372ab231fd55"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab1fe9da34b8e7f2bc2fc372ab231fd55">&#9670;&nbsp;</a></span>mpu_region_enable()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int mpu_region_enable </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="arm_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>&#160;</td>
          <td class="paramname"><em>region</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>base_addr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="arm_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>&#160;</td>
          <td class="paramname"><em>size_log2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="arm_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>&#160;</td>
          <td class="paramname"><em>execute</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="arm_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>&#160;</td>
          <td class="paramname"><em>write</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>enables an aligned memory protection region </p>
<p>Helper function used locally to wrap mapping desired MPU configuration into proper encodings for MPU RNR, RBAR, and RASR fields.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">region</td><td>region number to enable </td></tr>
    <tr><td class="paramname">base_addr</td><td>region's base address </td></tr>
    <tr><td class="paramname">size_log2</td><td>ceil(log_2) of the region's size </td></tr>
    <tr><td class="paramname">execute</td><td>indicator/non-zero if region is executable </td></tr>
    <tr><td class="paramname">write</td><td>indicator/non-zero if region is writable</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>-1 on error, 0 otherwise </dd></dl>

</div>
</div>
<a id="a61da86fe203ca5a3604409503ce1b3ca"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a61da86fe203ca5a3604409503ce1b3ca">&#9670;&nbsp;</a></span>mpu_thread_region_disable()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void mpu_thread_region_disable </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Deactive the memory protection region associated with the user stack. Will always deactive region 6 (as this is what is assigned above). </p>

</div>
</div>
<a id="a501ff979f58c03b4993d2cbb8f9db40d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a501ff979f58c03b4993d2cbb8f9db40d">&#9670;&nbsp;</a></span>mpu_thread_region_enable()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void mpu_thread_region_enable </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>base_addr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="arm_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>&#160;</td>
          <td class="paramname"><em>size</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Creates a user stack thread memory protection region according to whether the user wants to protect individual threads or just the kernel. If the user application only wants to protect kernel, a single region covers the entire range of thread user stack space (else this thread should only access its own user stack space). Thread will have RW access to its own user stack space. </p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_dc43877d82dd332f9fb2071fcca799d6.html">kernel</a></li><li class="navelem"><a class="el" href="dir_3dd30a497388ee684638f120a124721c.html">src</a></li><li class="navelem"><a class="el" href="mpu_8c.html">mpu.c</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
